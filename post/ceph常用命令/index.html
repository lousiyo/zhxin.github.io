<!doctype html><html lang><head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content="工作中遇到的比较常用的命令,特此整理以备忘.

查看集群状态

ceph -s #查看状态
ceph -v #查看版本
ceph df #查询集群存储容量
ceph health detail #集群详细健康信息
">
<title>
常用ceph命令
</title>
<link rel="shortcut icon" type=image/x-icon href=/>
<link rel=stylesheet href=/css/main.bef01a829bb1c9fd7cdb729389ad566cfc9307995368e1afee57d68d263c2a12021ef00b3fdc7fc093997f030ae50016cf41c40e8226eca398bf8df7da238d9e.css integrity="sha512-vvAagpuxyf1823KTia1WbPyTB5lTaOGv7lfWjSY8KhICHvALP9x/wJOZfwMK5QAWz0HEDoIm7KOYv4332iONng==">
</head>
<body a=light>
<main class=page-content aria-label=Content>
<div class=w>
<a href=/>&lt;-</a>
<article>
<p class=post-meta>
<time datetime="2021-02-28 22:49:38 +0800 CST">
2021-02-28
</time>
</p>
<h1>常用ceph命令</h1>
<p>工作中遇到的比较常用的命令,特此整理以备忘.</p>
<ul>
<li>查看集群状态</li>
</ul>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>ceph -s <span class=c1>#查看状态</span>
ceph -v <span class=c1>#查看版本</span>
ceph df <span class=c1>#查询集群存储容量</span>
ceph health detail <span class=c1>#集群详细健康信息</span>
</code></pre></div><ul>
<li>查询集群组件信息相关命令</li>
</ul>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>rados lspools <span class=c1>#查询池子列表</span>
ceph osd dump <span class=p>|</span> grep pool <span class=c1>#查询所有池子信息</span>
rados -p &lt;pool&gt; ls <span class=c1>#池子下对象</span>
rados --pgid &lt;pgid&gt; ls <span class=c1>#查看pg下对象</span>
ceph osd map &lt;pool&gt; object <span class=c1>#查看对象信息</span>
ceph-objectstore-tool --data-path &lt;datapath&gt; --journal-path &lt;journalpath&gt; &lt;objname&gt; dump <span class=c1>#输出对象元数据信息</span>
ceph-admin-disktool --getdisks  <span class=c1>#获取磁盘信息</span>

<span class=c1>#mon信息</span>
ceph mon stat
ceph mon dump
ceph quorum_status

<span class=c1>#osd信息</span>
ceph osd tree
ceph osd dump
ceph osd find &lt;numeric_osd_id&gt;
ceph osd df tree <span class=c1>#查看集群空间使用率</span>

<span class=c1>#pg信息</span>
ceph pg stat
ceph pg dump
ceph pg dump_stuck unclean
</code></pre></div><ul>
<li>systemctl管理服务</li>
</ul>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>systemctl reset-failed ceph-osd@*   <span class=c1>#重置失败服务</span>
systemctl start ceph-osd.target     <span class=c1>#重启osd服务</span>
systemctl restart ceph.target   <span class=c1>#重启ceph服务</span>
systemctl stop ceph-osd@0   <span class=c1>#停止单个osd服务</span>
systemctl status ceph-osd@1 <span class=c1>#查看服务状态</span>
</code></pre></div><ul>
<li>集群操作命令</li>
</ul>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>ceph osd pool delete &lt;pool&gt; &lt;pool&gt; --yes-i-really-really-mean-it    <span class=c1>#删除池</span>
rados put &lt;oid&gt; &lt;filename&gt; --pool<span class=o>=</span>&lt;pool&gt; <span class=c1>#在池中添加对象</span>
eph osd pool create &lt;pool&gt; &lt;pgnum&gt; &lt;pgnum&gt; -r &lt;host、osd&gt;  <span class=c1>#创建池</span>
</code></pre></div><ul>
<li>crush相关操作</li>
</ul>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>ceph osd crush dump
ceph osd crush rule list
ceph osd crush rule dump &lt;crush rule name&gt;
<span class=c1>#在线修改crush rule</span>
ceph osd getcrushmap -o &lt;map_old&gt;    <span class=c1>#导出map</span>
crushtool -d &lt;map_old&gt; -o &lt;map_old.txt&gt;  <span class=c1>#转化成可编辑格式</span>
vi map_old.txt <span class=c1>#修改rule replicated_ruleset step chooseleaf firstn 0 type *osd*</span>
crushtool -c &lt;map_old.txt&gt; -o &lt;map_new&gt;  <span class=c1>#还原为map</span>
ceph osd setcrushmap -i &lt;map_new&gt;     <span class=c1>#将map导入ceph</span>
</code></pre></div><ul>
<li>块设备管理命令</li>
</ul>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>ceph osd pool create &lt;rbd&gt; &lt;pgnum&gt; &lt;pgnum&gt;
ceph osd pool <span class=nb>set</span> &lt;rbd&gt; size &lt;repnum&gt;
rbd create --image &lt;my_image&gt; --size &lt;1T&gt; --pool &lt;rbd&gt;
rbd ls -p &lt;pool_name&gt; <span class=c1>#查看指定pool中的卷</span>
rbd trash move/mv &lt;images_name&gt; -p &lt;pool_name&gt; <span class=c1>#将卷丢到回收站</span>
rbd trash restore &lt;ID&gt; -p &lt;pool_name&gt; <span class=c1>#将回收站中的卷还原</span>
rbd trash remove/rm &lt;ID&gt; -p &lt;pool_name&gt; <span class=c1>#清除回收站中的卷</span>
</code></pre></div><ul>
<li>配置命令</li>
</ul>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>ceph --show-config <span class=c1>#查询集群默认配置</span>

ceph daemon &lt;mon.5&gt; config show <span class=p>|</span> grep &lt;mon_osd_down_out_interval&gt; <span class=c1>#查询进程配置信息</span>
<span class=c1>#修改运行配置信息 临时生效</span>
ceph tell &lt;daemon-type&gt;.&lt;daemon id or *&gt; injectargs --&lt;name&gt; &lt;value&gt;
ceph tell osd.0 injectargs <span class=s1>&#39;--debug-osd 0/5&#39;</span>
</code></pre></div><ul>
<li>其他</li>
</ul>
<ol>
<li><em>出现由于mon服务没有起来导致的admin_socket问题，可能原因是mon对所在分区目录空间的要求不满足(默认5%）清除部分空间即可;</em></li>
</ol>
</article>
</div>
</main>
</body>
</html>