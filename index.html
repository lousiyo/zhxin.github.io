<!doctype html><html lang=zh dir=auto>
<head>
<meta name=generator content="Hugo 0.92.2"><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>zhxin</title>
<meta name=description content>
<meta name=author content="zhxin">
<link rel=canonical href=https://zhxin.xyz/>
<link crossorigin=anonymous href=/assets/css/stylesheet.3613efbd0b1772781e8f49935e973cae632a7f61471c05b17be155505ccf87b5.css integrity="sha256-NhPvvQsXcngej0mTXpc8rmMqf2FHHAWxe+FVUFzPh7U=" rel="preload stylesheet" as=style>
<link rel=icon href=https://zhxin.xyz/%3Clink%20/%20abs%20url%3E>
<link rel=icon type=image/png sizes=16x16 href=https://zhxin.xyz/%3Clink%20/%20abs%20url%3E>
<link rel=icon type=image/png sizes=32x32 href=https://zhxin.xyz/%3Clink%20/%20abs%20url%3E>
<link rel=apple-touch-icon href=https://zhxin.xyz/%3Clink%20/%20abs%20url%3E>
<link rel=mask-icon href=https://zhxin.xyz/%3Clink%20/%20abs%20url%3E>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<link rel=alternate type=application/rss+xml href=https://zhxin.xyz/index.xml>
<noscript>
<style>#theme-toggle,.top-link{display:none}</style>
</noscript>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-109514401-1','auto'),ga('send','pageview'))</script><meta property="og:title" content="zhxin">
<meta property="og:description" content>
<meta property="og:type" content="website">
<meta property="og:url" content="https://zhxin.xyz/"><meta property="og:image" content="https://zhxin.xyz/bg.jpg"><meta property="og:site_name" content="zhxin">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://zhxin.xyz/bg.jpg">
<meta name=twitter:title content="zhxin">
<meta name=twitter:description content>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"Organization","name":"zhxin","url":"https://zhxin.xyz/","description":"","thumbnailUrl":"https://zhxin.xyz/%3Clink%20/%20abs%20url%3E","sameAs":["https://twitter.com/HongxinZY","https://github.com/zhxin"]}</script>
</head>
<body class="list dark" id=top>
<script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove('dark')</script>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=https://zhxin.xyz/ accesskey=h title="ä¸»é¡µ (Alt + H)">
<img src=https://zhxin.xyz/apple-touch-icon.png alt aria-label=logo height=35>ä¸»é¡µ</a>
<div class=logo-switches>
<button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
</div>
</div>
<ul id=menu>
<li>
<a href=https://zhxin.xyz/categories/ title=åˆ†ç±»>
<span>åˆ†ç±»</span>
</a>
</li>
<li>
<a href=https://zhxin.xyz/tags/ title=æ ‡ç­¾>
<span>æ ‡ç­¾</span>
</a>
</li>
<li>
<a href=https://zhxin.xyz/search/ title="æœç´¢ (Alt + /)" accesskey=/>
<span>æœç´¢</span>
</a>
</li>
</ul>
</nav>
</header>
<main class=main>
<article class="first-entry home-info">
<header class=entry-header>
<h1></h1>
</header>
<div class=entry-content>
æ¬¢è¿!ğŸ‘‹
</div>
<footer class=entry-footer>
<div class=social-icons>
<a href=https://twitter.com/HongxinZY target=_blank rel="noopener noreferrer me" title=Twitter><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg>
</a>
<a href=https://github.com/zhxin target=_blank rel="noopener noreferrer me" title=Github><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg>
</a>
</div>
</footer>
</article>
<article class=post-entry>
<header class=entry-header>
<h2>Shellç¼–ç¨‹åŸºç¡€
</h2>
</header>
<div class=entry-content>
<p>å˜é‡ è„šæœ¬å¼€å¤´ä½¿ç”¨#!/bin/bashæŒ‡å®šè¦ä½¿ç”¨çš„shell,shellä¼šé€šè¿‡PATHç¯å¢ƒå˜é‡æ¥æŸ¥æ‰¾è„šæœ¬ä¸­ä½¿ç”¨çš„å‘½ä»¤ï¼Œå¯ä»¥ä½¿ç”¨echo $PATHæ¥çœ‹ä¸‹è„šæœ¬ä¼šåœ¨å“ªäº›ç›®å½•ä¸‹æŸ¥æ‰¾å‘½ä»¤ï¼Œå¦‚æœè„šæœ¬ä¸­æ‰§è¡Œçš„å‘½ä»¤æ²¡æœ‰åœ¨PATHç¯å¢ƒå˜é‡ä¸­ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ç»å¯¹æˆ–ç›¸å¯¹è·¯å¾„æ¥å¼•ç”¨.
åœ¨è„šæœ¬ä¸­å¯ä»¥ä½¿ç”¨shellç»´æŠ¤çš„ç¯å¢ƒå˜é‡ä¹Ÿå¯ä»¥å®šä¹‰å’Œä½¿ç”¨è‡ªå·±çš„ç”¨æˆ·å˜é‡.
èµ‹å€¼ç­‰å·ä¸¤è¾¹ä¸èƒ½å­˜åœ¨ç©ºæ ¼
ç¯å¢ƒå˜é‡ï¼š
å¯ä»¥ä½¿ç”¨setå‘½ä»¤æŸ¥çœ‹å½“å‰ç¯å¢ƒå˜é‡åˆ—è¡¨,ä¾‹å¦‚$HOMEã€$HOSTNAMEã€$USERç­‰;
ç”¨æˆ·å˜é‡ï¼š
ç”±å­—æ¯æ•°å­—ä¸‹åˆ’çº¿ç»„æˆï¼Œé•¿åº¦ä¸è¶…è¿‡äºŒåï¼ŒåŒºåˆ†å¤§å°å†™ï¼Œå˜é‡ã€ç­‰å·ã€å€¼ä¹‹é—´ä¸èƒ½æœ‰ç©ºæ ¼ï¼Œåœ¨shellè„šæœ¬ç»“æŸæ—¶ä¼šè¢«åˆ é™¤æ‰ï¼Œä½¿ç”¨ç¾å…ƒç¬¦å·å¼•ç”¨ï¼Œä¾‹å¦‚name="test"ã€‚
ä½¿ç”¨ç”¨æˆ·å˜é‡ä¿å­˜å‘½ä»¤æ‰§è¡Œç»“æœï¼štesting=$(date)
ç‰¹æ®Šå‚æ•°å˜é‡
å‚æ•° æè¿° $0 $1 $2 å…¥å‚ $# å‚æ•°ä¸ªæ•° $* å…¥å‚åˆ—è¡¨ï¼Œå°†æ‰€æœ‰å‚æ•°å½“ä½œå•ä¸ªå‚æ•° $@ å…¥å‚åˆ—è¡¨ï¼Œå•ç‹¬å¤„ç†æ¯ä¸ªå‚ é‡å®šå‘è¾“å…¥è¾“å‡º è¾“å‡ºé‡å®šå‘: > è¿½åŠ ï¼š>>
è¾“å…¥é‡å®šå‘: &lt; åœ¨è„šæœ¬ä¸­ä½¿ç”¨&lt; > éœ€è¦è¿›è¡Œè½¬ä¹‰\&lt; \>
å†…è”è¾“å…¥é‡å®šå‘ï¼š
command &lt;&lt; marker content marker # ä¾‹å¦‚ï¼š wc -l &lt;&lt;EOF echo "aaa" echo "BBB" EOF å†…è”é‡å®šå‘åˆ°æ–‡ä»¶...</p>
</div>
<footer class=entry-footer><span title="2021-06-28 22:49:38 +0800 CST">2021-06-28</span>&nbsp;Â·&nbsp;3 åˆ†é’Ÿ&nbsp;Â·&nbsp;557 å­—&nbsp;Â·&nbsp;zhxin</footer>
<a class=entry-link aria-label="post link to Shellç¼–ç¨‹åŸºç¡€" href=https://zhxin.xyz/post/shell_script/></a>
</article>
<article class=post-entry>
<header class=entry-header>
<h2>PG Peeringè¿‡ç¨‹çŠ¶æ€å˜åŒ–ä»£ç èµ°è¯»
</h2>
</header>
<div class=entry-content>
<p>æœ€è¿‘çœ‹äº†PGçŠ¶æ€è½¬æ¢çš„è¿‡ç¨‹,ä»£ç ç»†èŠ‚æ²¡æœ‰ä»”ç»†ç ”ç©¶ï¼Œå…ˆç²—ç•¥è¿‡äº†ä¸€éä»£ç ï¼Œç‰¹æ­¤è®°å½•.
PG PGæ˜¯å­˜å‚¨æ± çš„åŸºæœ¬å•å…ƒï¼Œæ˜¯ä¸€äº›å¯¹è±¡çš„é›†åˆï¼Œå¤šå‰¯æœ¬å’Œçº åˆ çš„æ•°æ®å¤‡ä»½ç­–ç•¥ä¾æ‰˜PGå®ç°. PGæœ‰å¤šç§çŠ¶æ€ï¼ŒçŠ¶æ€ä¹‹é—´çš„å˜åŒ–é€šè¿‡çŠ¶æ€æœºå®ç°.
æœ‰ä¸¤ä¸ªåœºæ™¯ä¼šè§¦å‘peeringæµç¨‹ï¼š
åœ¨pgåˆ›å»ºæ—¶ åœ¨OSDå¯åŠ¨ã€åœæ­¢å¯¼è‡´OSDMapå˜åŒ–è¿›è€Œå¯¼è‡´pgçš„acting setå‘ç”Ÿå˜åŒ–æ—¶ çŠ¶æ€æœº çŠ¶æ€æœºåœ¨åˆ›å»ºPGè¿›è¡Œåˆå§‹åŒ–.
class RecoveryMachine : public boost::statechart::state_machine&lt; RecoveryMachine, Initial > { RecoveryState *state; public: PG *pg; utime_t event_time; uint64_t event_count; ... boost::statechatåŒ…å«å¯¹è±¡ï¼š
state_machine: çŠ¶æ€æœº state: çŠ¶æ€ eventï¼šäº‹ä»¶ å¯é€šè¿‡process_eventå‡½æ•°è¿›è¡Œäº‹ä»¶æŠ•é€’ transition / custom_reaction: è½¬ç§»/ååº” custom_reactioné€šè¿‡å¯¹äºreactå‡½æ•°è¿›è¡Œå¤„ç† PGçŠ¶æ€æœºçš„å¯¹è±¡ã€çŠ¶æ€åŠæ—¶é—´å¤„ç†ä¸»è¦åœ¨PG.hã€PG.ccæ–‡ä»¶ä¸­. struct Initial : boost::statechart::state&lt; Initial, RecoveryMachine >, NamedState { explicit Initial(my_context ctx); void exit(); typedef boost::mpl::list &lt; boost::statechart::transition&lt; Initialize, Reset >, boost::statechart::custom_reaction&lt; Load >, boost::statechart::custom_reaction&lt; NullEvt >, boost::statechart::transition&lt; boost::statechart::event_base, Crashed > > reactions; boost::statechart::result react(const Load&); boost::statechart::result react(const MNotifyRec&); boost::statechart::result react(const MInfoRec&); boost::statechart::result react(const MLogRec&); boost::statechart::result react(const boost::statechart::event_base&) { return discard_event(); } }; PGçŠ¶æ€æœºä¸»è¦åŒ…å«çš„çŠ¶æ€å¦‚ä¸‹å›¾:...</p>
</div>
<footer class=entry-footer><span title="2021-05-28 22:49:38 +0800 CST">2021-05-28</span>&nbsp;Â·&nbsp;5 åˆ†é’Ÿ&nbsp;Â·&nbsp;869 å­—&nbsp;Â·&nbsp;zhxin</footer>
<a class=entry-link aria-label="post link to PG Peeringè¿‡ç¨‹çŠ¶æ€å˜åŒ–ä»£ç èµ°è¯»" href=https://zhxin.xyz/post/pg_state_change_code/></a>
</article>
<article class=post-entry>
<header class=entry-header>
<h2>Gitå®¢æˆ·ç«¯åˆå§‹é…ç½®
</h2>
</header>
<div class=entry-content>
<p> å®‰è£…å®ŒæˆGITä¹‹åé…ç½®ç›¸å…³ç”¨æˆ·åé‚®ç®±. git config --global user.name "zhxin" git config --global user.email zhxin@outlook.com ...</p>
</div>
<footer class=entry-footer><span title="2021-03-28 22:49:38 +0800 CST">2021-03-28</span>&nbsp;Â·&nbsp;1 åˆ†é’Ÿ&nbsp;Â·&nbsp;42 å­—&nbsp;Â·&nbsp;zhxin</footer>
<a class=entry-link aria-label="post link to Gitå®¢æˆ·ç«¯åˆå§‹é…ç½®" href=https://zhxin.xyz/post/git-client-config/></a>
</article>
<article class=post-entry>
<header class=entry-header>
<h2>[è½¬è½½]cephå­˜å‚¨å¼•æ“bluestoreè§£æ
</h2>
</header>
<div class=entry-content>
<p>è½¬è½½è‡ªsysnote,å¦‚æœ‰ä¾µæƒè¯·è”ç³»åˆ é™¤
cephåç«¯æ”¯æŒå¤šç§å­˜å‚¨å¼•æ“ï¼Œä»¥æ’ä»¶å¼çš„æ–¹å¼æ¥è¿›è¡Œç®¡ç†ä½¿ç”¨ï¼Œç›®å‰æ”¯æŒfilestoreï¼Œkvstoreï¼Œmemstoreä»¥åŠæœ€æ–°çš„bluestoreï¼Œç›®å‰é»˜è®¤ä½¿ç”¨çš„filestoreï¼Œä½†æ˜¯å› ä¸ºfilestoreåœ¨å†™æ•°æ®å‰éœ€è¦å…ˆå†™journalï¼Œä¼šæœ‰ä¸€å€çš„å†™æ”¾å¤§ï¼Œå¹¶ä¸”filestoreä¸€å¼€å§‹åªæ˜¯å¯¹äºæœºæ¢°ç›˜è¿›è¡Œè®¾è®¡çš„ï¼Œæ²¡æœ‰ä¸“é—¨é’ˆå¯¹ssdåšä¼˜åŒ–è€ƒè™‘ï¼Œå› æ­¤è¯ç”Ÿçš„bluestoreåˆè¡·å°±æ˜¯ä¸ºäº†å‡å°‘å†™æ”¾å¤§ï¼Œå¹¶é’ˆå¯¹ssdåšä¼˜åŒ–ï¼Œè€Œä¸”ç›´æ¥ç®¡ç†è£¸ç›˜ï¼Œä»ç†è®ºä¸Šè¿›ä¸€æ­¥å‡å°‘æ–‡ä»¶ç³»ç»Ÿå¦‚ext4/xfsç­‰éƒ¨åˆ†çš„å¼€é”€ï¼Œç›®å‰bluestoreè¿˜å¤„äºå¼€å‘ä¼˜åŒ–é˜¶æ®µï¼Œåœ¨jewelç‰ˆæœ¬è¿˜æ˜¯è¯•ç”¨ç‰ˆæœ¬ï¼Œå¹¶ä¸”æœ€æ–°çš„masterç›¸æ¯”jewelå·²ç»åšäº†å¤§çš„é‡æ„ï¼Œé¢„æœŸä¼šåœ¨åç»­çš„å¤§ç‰ˆæœ¬ä¸­ç¨³å®šä¸‹æ¥æˆä¸ºé»˜è®¤çš„å­˜å‚¨å¼•æ“ã€‚æœ¬æ–‡åŸºäºmasteråˆ†æ”¯å¯¹bluestoreå­˜å‚¨å¼•æ“è¿›è¡Œåˆ†æã€‚
bluestoreæ•´ä½“æ¶æ„ bluestoreç›´æ¥ç®¡ç†è£¸è®¾å¤‡ï¼ŒæŠ›å¼ƒäº†ext4/xfsç­‰æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿï¼ŒBlockDeviceå®ç°åœ¨ç”¨æˆ·æ€ä¸‹ä½¿ç”¨linux aioç›´æ¥å¯¹è£¸è®¾å¤‡è¿›è¡ŒI/Oæ“ä½œã€‚æ—¢ç„¶æ˜¯ç›´æ¥ç®¡ç†è£¸è®¾å¤‡å°±å¿…ç„¶éœ€è¦è¿›è¡Œè£¸è®¾å¤‡çš„ç©ºé—´ç®¡ç†ï¼Œå¯¹åº”çš„å°±æ˜¯Allocatorï¼Œç›®å‰æ”¯æŒStupidAllocatorå’ŒBitmapAllocatorä¸¤ç§åˆ†é…å™¨ã€‚ç›¸å…³çš„å…ƒæ•°æ®ä»¥kvçš„å½¢å¼ä¿å­˜åˆ°kvæ•°æ®åº“é‡Œï¼Œé»˜è®¤ä½¿ç”¨çš„æ˜¯rocksdbï¼Œç”±äºrocksdbæœ¬èº«æ˜¯åŸºäºæ–‡ä»¶ç³»ç»Ÿçš„ï¼Œä¸æ˜¯ç›´æ¥æ“ä½œè£¸è®¾å¤‡ï¼Œä½†æ˜¯rocksdbä¹Ÿæ¯”è¾ƒçµæ´»ï¼Œå°†ç³»ç»Ÿç›¸å…³çš„å¤„ç†æŠ½è±¡æˆEnvï¼Œç”¨æˆ·å¯ç”¨å®ç°ç›¸åº”çš„æ¥å£ï¼Œrocksdbé»˜è®¤çš„Envæ˜¯PosixEnvï¼Œç›´æ¥å¯¹æ¥æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿï¼Œä¸ºæ­¤ï¼Œbluestoreå®ç°äº†ä¸€ä¸ªBlueRocksEnvï¼Œç»§æ‰¿è‡ªEnvWrapperï¼Œæ¥ä¸ºrocksdbæä¾›åº•å±‚ç³»ç»Ÿçš„å°è£…ï¼Œä¸ºäº†å¯¹æ¥BlueRocksEnvï¼Œå®ç°äº†ä¸€ä¸ªå°çš„æ–‡ä»¶ç³»ç»ŸBlueFSï¼Œåªå®ç°rocksdb Envéœ€è¦çš„æ¥å£ï¼Œåœ¨ç³»ç»Ÿå¯åŠ¨mountè¿™ä¸ªæ–‡ä»¶ç³»ç»Ÿçš„æ—¶å€™å°†æ‰€æœ‰çš„å…ƒæ•°æ®éƒ½åŠ è½½åˆ°å†…å­˜ä¸­ï¼ŒBluesFSçš„æ•°æ®å’Œæ—¥å¿—æ–‡ä»¶éƒ½é€šè¿‡BlockDeviceä¿å­˜åˆ°è£¸è®¾å¤‡ä¸Šï¼ŒBlueFSå’ŒBlueStoreå¯ä»¥å…±äº«è£¸è®¾å¤‡ï¼Œä¹Ÿå¯ä»¥åˆ†åˆ«æŒ‡å®šä¸åŒçš„è®¾å¤‡ã€‚
bluestoreå…ƒæ•°æ® åœ¨ä¹‹å‰çš„å­˜å‚¨å¼•æ“filestoreé‡Œï¼Œå¯¹è±¡çš„è¡¨ç°å½¢å¼æ˜¯å¯¹åº”åˆ°æ–‡ä»¶ç³»ç»Ÿé‡Œçš„æ–‡ä»¶ï¼Œé»˜è®¤4MBå¤§å°çš„æ–‡ä»¶ï¼Œä½†æ˜¯åœ¨bluestoreé‡Œï¼Œå·²ç»æ²¡æœ‰ä¼ ç»Ÿçš„æ–‡ä»¶ç³»ç»Ÿï¼Œè€Œæ˜¯è‡ªå·±ç®¡ç†è£¸ç›˜ï¼Œå› æ­¤éœ€è¦æœ‰å…ƒæ•°æ®æ¥ç®¡ç†å¯¹è±¡ï¼Œå¯¹åº”çš„å°±æ˜¯Onodeï¼ŒOnodeæ˜¯å¸¸é©»å†…å­˜çš„æ•°æ®ç»“æ„ï¼ŒæŒä¹…åŒ–çš„æ—¶å€™ä¼šä»¥kvçš„å½¢å¼å­˜åˆ°rocksdbé‡Œã€‚
åœ¨onodeé‡Œåˆåˆ†ä¸ºlextentï¼Œè¡¨ç¤ºé€»è¾‘çš„æ•°æ®å—ï¼Œç”¨ä¸€ä¸ªmapæ¥è®°å½•ï¼Œä¸€ä¸ªonodeé‡Œä¼šå­˜åœ¨å¤šä¸ªlextentï¼Œlextenté€šè¿‡blobçš„idå¯¹åº”åˆ°blobï¼ˆbluestore_blob_t ï¼‰ï¼Œblobé‡Œé€šè¿‡pextentå¯¹åº”åˆ°å®é™…ç‰©ç†ç›˜ä¸Šçš„åŒºåŸŸï¼ˆpextenté‡Œå°±æ˜¯offsetå’Œlengthæ¥å®šä½ç‰©ç†ç›˜çš„ä½ç½®åŒºåŸŸï¼‰ã€‚ä¸€ä¸ªonodeé‡Œçš„å¤šä¸ªlextentå¯èƒ½åœ¨åŒä¸€ä¸ªblobé‡Œï¼Œè€Œä¸€ä¸ªblobä¹Ÿå¯èƒ½å¯¹åº”åˆ°å¤šä¸ªpextentã€‚ å¦å¤–è¿˜æœ‰Bnodeè¿™ä¸ªå…ƒæ•°æ®ï¼Œå®ƒæ˜¯ç”¨æ¥è¡¨ç¤ºå¤šä¸ªobjectå¯èƒ½å…±äº«extentï¼Œç›®å‰åœ¨åšäº†å¿«ç…§åå†™I/Oè§¦å‘çš„cowè¿›è¡Œcloneçš„æ—¶å€™ä¼šç”¨åˆ°ã€‚
I/Oè¯»å†™æ˜ å°„é€»è¾‘ å†™I/Oå¤„ç† åˆ°è¾¾bluestoreçš„I/Oçš„offsetå’Œlengthéƒ½æ˜¯å¯¹è±¡å†…ï¼ˆonodeï¼‰çš„ï¼Œoffsetæ˜¯ç›¸å¯¹äºè¿™ä¸ªå¯¹è±¡èµ·å§‹ä½ç½®çš„åç§»ï¼Œåœ¨_do_writeé‡Œé¦–å…ˆå°±ä¼šæ ¹æ®æœ€å°åˆ†é…å•ä½min_alloc_sizeè¿›è¡Œåˆ¤æ–­ï¼Œä»è€Œå°†I/Oåˆ†ä¸ºå¯¹é½å’Œéå¯¹é½çš„ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š
å½“ä¸€ä¸ªå†™è¯·æ±‚æŒ‰ç…§min_alloc_sizeè¿›è¡Œæ‹†åˆ†åï¼Œå°±ä¼šåˆ†ä¸ºå¯¹é½å†™ï¼Œå¯¹åº”åˆ°do_write_bigï¼Œéå¯¹é½å†™ï¼ˆå³è½åˆ°æŸä¸€ä¸ªmin_alloc_sizeåŒºé—´çš„å†™I/Oï¼ˆå¯¹åº”åˆ°do_write_smallï¼‰ã€‚
do_write_big å¯¹é½åˆ°min_alloc_sizeçš„å†™è¯·æ±‚å¤„ç†èµ·æ¥æ¯”è¾ƒç®€å•ï¼Œæœ‰å¯èƒ½æ˜¯å¤šä¸ªmin_alloc_sizeçš„å¤§å°ï¼Œåœ¨å¤„ç†æ—¶ä¼šæ ¹æ®å®é™…å¤§å°æ–°ç”Ÿæˆlextentå’Œblobï¼Œè¿™ä¸ªlextentè·¨è¶Šçš„åŒºåŸŸæ˜¯min_alloc_sizeçš„æ•´æ•°å€ï¼Œå¦‚æœè¿™æ®µåŒºé—´æ˜¯ä¹‹å‰å†™è¿‡çš„ï¼Œä¼šå°†ä¹‹å‰çš„lextentè®°å½•ä¸‹æ¥ä¾¿äºåç»­çš„ç©ºé—´å›æ”¶ã€‚
do_write_small åœ¨å¤„ç†è½åˆ°æŸä¸ªmin_alloc_sizeåŒºé—´çš„å†™è¯·æ±‚æ—¶ï¼Œä¼šé¦–å…ˆæ ¹æ®offsetå»æŸ¥æ‰¾æœ‰æ²¡æœ‰å¯ä»¥å¤ç”¨çš„blobï¼Œå› ä¸ºæœ€å°åˆ†é…å•å…ƒæ˜¯min_alloc_sizeï¼Œé»˜è®¤64KBï¼Œå¦‚æœä¸€ä¸ª4KBçš„å†™I/Oå°±åªä¼šç”¨åˆ°blobçš„ä¸€éƒ¨åˆ†ï¼Œblobé‡Œå‰©ä½™çš„è¿˜èƒ½æ”¾å…¶ä»–çš„ã€‚
æ²¡æœ‰æ‰¾åˆ°å¯ä»¥å¤ç”¨çš„blobï¼Œæ–°ç”Ÿæˆblob åœ¨å¤„ç†è¿˜è¿˜éœ€è¦æ ¹æ®offsetå’Œlenæ˜¯å¦å¯¹é½åˆ°block_sizeï¼ˆé»˜è®¤æ˜¯4KBï¼‰è¿›è¡Œè¡¥é›¶å¯¹é½çš„æ“ä½œï¼Œä¹‹æ‰€ä»¥éœ€è¦è¡¥é½æ˜¯ä¸åç»­çš„å†™ç›˜æ“ä½œæœ‰å…³ï¼ŒçœŸæ­£å†™ç›˜æ—¶æœ‰ä¸¤ç§æ–¹å¼ï¼Œä¸€ç§æ˜¯Direct I/Oçš„æ–¹å¼ï¼Œè¿™ç§è¦æ±‚åç§»å’Œç¼“å†²åŒºéƒ½å¯¹é½çš„ï¼Œå¦å¤–ä¸€ç§éDirect I/Oï¼Œå³Buffered I/Oï¼Œè¿™ç§å¯ä»¥ä¸å¯¹é½ï¼Œä½†æ˜¯æ˜¯å†™åˆ°cacheé‡Œï¼Œç„¶åå†syncåˆ·åˆ°ç£ç›˜ä¸Šï¼Œæ¯”å¦‚åªå†™äº†100å­—èŠ‚ï¼Œåœ¨å†…æ ¸é‡Œæ˜¯éœ€è¦å…ˆä»è®¾å¤‡ä¸Šè¯»å‡ºæ¥è¡¥é½æˆä¸€ä¸ªå®Œæ•´çš„æ‰‡åŒºï¼Œç„¶åå†åˆ·çš„ï¼Œè¿™æ ·åè€Œé™ä½äº†æ•ˆç‡ã€‚å› æ­¤åœ¨bluestoreé‡Œç›´æ¥å¤„ç†å¥½å¯¹é½ï¼Œå¯¹äºåé¢çš„å†™ç›˜æ¥è¯´æ¯”è¾ƒæœ‰åˆ©ï¼Œè¿™é‡Œå¯¹é½åˆ°block_sizeï¼Œæ˜¯ä¸ªå¯é…ç½®çš„å‚æ•°ã€‚
è¿›è¡Œå¯¹é½è¡¥é›¶æ—¶å°±æ˜¯æŒ‰ç…§å¦‚ä¸Šå›¾é‚£æ ·æŠŠå‰åå¯¹é½åˆ°block_sizeï¼Œç„¶åå†æŠŠå¯¹é½åçš„offsetå’Œlenä½œä¸ºlextentï¼Œè¿›è€Œæ”¾åˆ°blobé‡Œã€‚ 2. æ‰¾åˆ°å¯ä»¥å¤ç”¨çš„blob
å¯¹äºå¯ä»¥å¤ç”¨çš„blobï¼Œä¹Ÿæ˜¯å…ˆæŒ‰ç…§block_sizeè¿›è¡Œå¯¹é½è¡¥é›¶çš„åŠ¨ä½œï¼Œç„¶åå†åˆ¤æ–­æ˜¯å¦å¯ä»¥ç›´æ¥ä½¿ç”¨blobé‡Œç©ºé—²çš„ç©ºé—´è¿›è¡ŒåŒºåˆ†åšä¸åŒçš„å¤„ç†ã€‚
a. ç›´æ¥å†™åœ¨blobæœªä½¿ç”¨çš„ç©ºé—´ä¸Š
è¿™ç§æƒ…å†µä¸‹ç›´æ¥æ–°ç”Ÿæˆlextentæ”¾åˆ°blobé‡Œã€‚
b. è¦†ç›–å†™çš„æƒ…å†µ
æ¯”å¦‚ä¸‹é¢çš„è¿™ç§æƒ…å†µï¼Œå†™I/Oä¼šè¦†ç›–éƒ¨åˆ†å·²ç»å†™è¿‡çš„æ•°æ®ã€‚
å¯¹äºè¿™ç§æƒ…å†µçš„å¤„ç†å¦‚ä¸‹å›¾ï¼šä¹Ÿæ˜¯éœ€è¦å…ˆå¤„ç†å¯¹é½è¡¥é›¶çš„æƒ…å†µï¼Œå¦‚æœè¦†ç›–çš„åŒºåŸŸåˆšå¥½æ˜¯å·²ç»å¯¹é½åˆ°block_sizeï¼Œé‚£ä¹ˆå°±ä¸éœ€è¦ä»ç£ç›˜è¯»æ•°æ®ï¼Œä½†æ˜¯å¦‚æœè¦†ç›–çš„åŒºåŸŸæ²¡æœ‰å¯¹é½åˆ°block_sizeï¼Œé‚£ä¹ˆå°±éœ€è¦æŠŠä¸å¯¹é½çš„é‚£éƒ¨åˆ†è¯»å‡ºæ¥ï¼Œæ‹¼æˆä¸€ä¸ªå¯¹é½çš„bufferï¼Œç„¶åæ–°ç”Ÿæˆlextentï¼Œå¹¶ä¸”ä¼šå¯¹åŸæ¥é‚£ä¸ªlextentè¿›è¡Œè°ƒæ•´ï¼Œä¼šè®°å½•éœ€è¦å›æ”¶çš„é‚£éƒ¨åˆ†åŒºåŸŸã€‚å¯¹äºè¦†ç›–å†™çš„æƒ…å†µï¼Œéƒ½ä¸æ˜¯ç›´æ¥å†™ç›˜ï¼Œè€Œæ˜¯é€šè¿‡walå†™åˆ°rocksdbã€‚
æ•´ä½“å†™I/Oçš„é€»è¾‘ ä¹‹å‰ç»„å†…åŒäº‹ç”»è¿‡ä¸€ä¸ªæµç¨‹å›¾ï¼Œè¿™é‡Œå€Ÿç”¨ä¸€ä¸‹ç®—æ˜¯ä¸€ä¸ªç®€å•çš„æ€»ç»“ã€‚
è¯»I/Oçš„å¤„ç† è¯»I/Oè¯·æ±‚çš„å¤„ç†æ—¶ä¹Ÿæ˜¯é€šè¿‡å¯»æ‰¾ç›¸å…³è”çš„lextentï¼Œå¯èƒ½ä¼šå­˜åœ¨ç©ºæ´çš„æƒ…å†µï¼Œå³è¯»åˆ°æœªå†™è¿‡çš„æ•°æ®ï¼Œè¿™éƒ¨åˆ†å°±ç›´æ¥è¡¥é›¶ã€‚
cloneåŠextentå…±äº« å‰é¢è¯´åˆ°Bnodeå°±æ˜¯ç”¨æ¥è®°å½•å…±äº«çš„lextentï¼Œç›®å‰æ˜¯åœ¨åšå®Œå¿«ç…§åå¯¹åŸå·è¿›è¡Œå†™I/Oä¼šè§¦å‘cowï¼Œä»è€Œäº§ç”Ÿcloneæ“ä½œã€‚cloneæ—¶å°±æ˜¯å°†åŸå¯¹è±¡çš„blobä»onode->blob_mapç§»åˆ°onode->bnode->blob_mapï¼Œå¹¶ä¸”å°†blob idç½®ä¸ºè´Ÿçš„ï¼Œå¹¶è®¾ç½®å…±äº«æ ‡è®°ï¼Œç„¶åå°†æ–°çš„å¿«ç…§å¯¹è±¡çš„onode->bnodeæŒ‡å‘åŸå¯¹è±¡çš„onode->bnodeï¼Œå¹¶ä¸”ç”¨åŸonodeé‡Œçš„lextentsé‡Œçš„å€¼èµ‹ç»™æ–°çš„onodeçš„lextentsï¼Œä»è€Œè¾¾åˆ°å…±äº«extentçš„ç›®çš„ï¼Œå›¾ç¤ºä»…ä¾›å‚è€ƒã€‚
åœ¨cloneå®Œä¹‹åï¼Œç»§ç»­å¯¹åŸå¯¹è±¡è¿›è¡Œå†™I/Oæ“ä½œæ—¶ï¼Œå½“ç¢°åˆ°å…±äº«çš„blobæ—¶å°±éœ€è¦è·³è¿‡ï¼Œæ–°ç”Ÿæˆblobï¼Œå¹¶ä¸”å–æ¶ˆå¯¹åŸæ¥é‚£éƒ¨åˆ†lextentçš„å¼•ç”¨ï¼Œåœ¨åç»­çš„ç©ºé—´é‡Šæ”¾æ—¶çš„åˆ¤æ–­ä¾æ®å°±æ˜¯å¦è¿˜æœ‰å¼•ç”¨ã€‚
å°ç»“ æœ¬æ–‡æ€»ä½“ä¸Šä»‹ç»äº†bluestoreçš„æ¶æ„ã€ç›¸å…³å…ƒæ•°æ®åŠå†…éƒ¨I/Oæ˜ å°„çš„é€»è¾‘ï¼Œè¿™è¿˜åªæ˜¯bluestoreçš„å†°å±±ä¸€è§’ï¼Œåç»­ä¼šé™†ç»­å¯¹bluestoreçš„å¤„ç†æµç¨‹ã€ç©ºé—´åˆ†é…å™¨ã€ç¼“å­˜ç®¡ç†ã€å‹ç¼©ç­‰å®ç°è¿›è¡Œåˆ†æã€‚</p>
</div>
<footer class=entry-footer><span title="2021-02-28 22:49:38 +0800 CST">2021-02-28</span>&nbsp;Â·&nbsp;1 åˆ†é’Ÿ&nbsp;Â·&nbsp;45 å­—&nbsp;Â·&nbsp;zhxin</footer>
<a class=entry-link aria-label="post link to [è½¬è½½]cephå­˜å‚¨å¼•æ“bluestoreè§£æ" href=https://zhxin.xyz/post/ceph_bluestore_summary/></a>
</article>
<article class=post-entry>
<header class=entry-header>
<h2>å¸¸ç”¨cephå‘½ä»¤
</h2>
</header>
<div class=entry-content>
<p>å·¥ä½œä¸­é‡åˆ°çš„æ¯”è¾ƒå¸¸ç”¨çš„å‘½ä»¤,ç‰¹æ­¤æ•´ç†ä»¥å¤‡å¿˜.
æŸ¥çœ‹é›†ç¾¤çŠ¶æ€ ceph -s #æŸ¥çœ‹çŠ¶æ€ ceph -v #æŸ¥çœ‹ç‰ˆæœ¬ ceph df #æŸ¥è¯¢é›†ç¾¤å­˜å‚¨å®¹é‡ ceph health detail #é›†ç¾¤è¯¦ç»†å¥åº·ä¿¡æ¯ ...</p>
</div>
<footer class=entry-footer><span title="2021-02-28 22:49:38 +0800 CST">2021-02-28</span>&nbsp;Â·&nbsp;2 åˆ†é’Ÿ&nbsp;Â·&nbsp;270 å­—&nbsp;Â·&nbsp;zhxin</footer>
<a class=entry-link aria-label="post link to å¸¸ç”¨cephå‘½ä»¤" href=https://zhxin.xyz/post/ceph%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/></a>
</article>
<footer class=page-footer>
<nav class=pagination>
<a class=next href=https://zhxin.xyz/page/2/>ä¸‹ä¸€é¡µ&nbsp;&nbsp;Â»
</a>
</nav>
</footer>
</main>
<footer class=footer>
<span>&copy; 2023 <a href=https://zhxin.xyz/>zhxin</a></span>
<span>
Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a>
</span>
</footer>
<a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a>
<script>let menu=document.getElementById('menu');menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script>
</body>
</html>